---
title: "`r FlomicsMultiAssay@metadata$projectName` project analysis"
author: "Analysis performed by RFLOMICS package"
date: "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: bibliography.bib
output: 
  html_document:
    df_print: paged
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
    theme: united
params: 
  pngDir: NA
  FEdata: NA
---


```{r , include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r library, echo=FALSE}

library(RFLOMICS)
library(dplyr)
library(ggplot2)
library(DT)
library(reactable)

```



```{r parameters, include=FALSE}

load(params$FEdata)
pngDir <- params$pngDir

```


# Experimental Design :


<!-- ## Sample sheet overview -->

```{r Design, echo=FALSE, message=TRUE, warning=TRUE}

DT::datatable(as.data.frame(FlomicsMultiAssay@colData), 
              options = list(rownames = FALSE, pageLength = 10, scrollX = T, dom = 'tip'),
              class = 'cell-border stripe')

```


```{r factors, echo=FALSE, message=TRUE, warning=TRUE}

Bio.fact   <- FlomicsMultiAssay@metadata$design@Factors.Type[FlomicsMultiAssay@metadata$design@Factors.Type == "Bio"]
Batch.fact <- FlomicsMultiAssay@metadata$design@Factors.Type[FlomicsMultiAssay@metadata$design@Factors.Type == "batch"]

```

* `r paste0("Biological factor : ",  paste0(names(Bio.fact), collapse = ", "))`
* `r paste0("Batch factor : ",  paste0(names(Batch.fact), collapse = ", "))`



## Check completeness

```{r CheckDesignExp, echo=FALSE, message=TRUE, warning=TRUE, out.width = "50%"}
check <- CheckExpDesignCompleteness(FlomicsMultiAssay@metadata$design)

check$plot
```


* The number of replicates per condition are: 

<!-- ```{r checkDesignAsis, echo=FALSE, results="asis", eval=FALSE} -->
<!-- kable_styling(kable(check$count, row.names=FALSE, caption=NULL,  format="html"), font_size=12, full_width = F, position = "left") -->
<!-- ``` -->

## Set statistical framework

* The statistical model written for the experiment is:  

```
`r FlomicsMultiAssay@metadata$design@Model.formula`
```

* The selected contrast(s) is (are):

```{r contrastSel, echo=FALSE, results="asis"}

DT::datatable(FlomicsMultiAssay@metadata$design@Contrasts.Sel[,c(5,2:3)], 
              options = list(rownames = FALSE, pageLength = 10, scrollX = T, dom = 'tip'),
              class = 'cell-border stripe')

# kable_styling(kable(FlomicsMultiAssay@metadata$design@Contrasts.Sel[,c(5,2:3)], 
#                     row.names=FALSE, caption=NULL, format="html"), font_size=12,full_width = F, position = "left")
```

# Datasets loaded:


```{r upsetSamples, echo=FALSE, fig.show = "hold", out.width = "70%", message=FALSE, warning=FALSE}

loaded.data <- data.frame(omics    = names(FlomicsMultiAssay@metadata$omicList),
                          datasets = sapply(names(FlomicsMultiAssay@metadata$omicList), 
                                            function(x){ paste0(FlomicsMultiAssay@metadata$omicList[[x]], collapse = ", ") }))

DT::datatable(loaded.data, 
              options = list(rownames = TRUE, pageLength = 10, scrollX = T, dom = 'tip'),
              class = 'cell-border stripe')

# kable_styling(kable(loaded.data, row.names=FALSE, caption=NULL, format="html"), font_size=12,full_width = F, position = "left")

if(length(unlist(FlomicsMultiAssay@metadata$omicList)) > 2){
  
  upsetSamples(FlomicsMultiAssay[unlist(FlomicsMultiAssay@metadata$omicList),])
}

```


`r if(length(FlomicsMultiAssay@metadata$omicList) ==0 ) {"\\begin{comment}"}`


```{r analysis, message=FALSE, warning=FALSE, echo=FALSE, echo=FALSE, message=TRUE, warning=TRUE}

  out <- NULL
  for (omictype in names(FlomicsMultiAssay@metadata$omicList)){ 
    
    child <- paste0(omictype, ".Rmd")

    for (data in  FlomicsMultiAssay@metadata$omicList[[omictype]]){
      
      out <- c(out, knitr::knit_child(child, quiet=TRUE))  
    }
    
  }

knitr::asis_output(out)

```

`r if(length(FlomicsMultiAssay@metadata$omicList) == 0 ) {"\\end{comment}"}`

<!-- Ajouter if pour test de MOFA2 results dans la table.
Tous les attributs des tests sont retrouvables dans l'objet MOFA2 de rflomics -->

# R Session

```{r session, message=FALSE, warning=FALSE, echo=FALSE, echo=FALSE, message=TRUE, warning=TRUE}
devtools::session_info()
```


# Bibliographie


