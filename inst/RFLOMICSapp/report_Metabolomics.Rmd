
# `r data` analysis

```{r conditionMeta, echo=FALSE}

dataset.raw.SE <- FlomicsMultiAssay@ExperimentList[[data]]
dataset.SE     <- FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]

Diff.eval <- !is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]])
CoEx.eval <- !is.null(dataset.SE@metadata[["CoExpAnal"]]$results)

```


### Description of dataset's processing

```{r CheckDesignMeta, echo=FALSE, message=FALSE, warning=FALSE}
check <- CheckExpDesignCompleteness(FlomicsMultiAssay)

filt.summary <-  data.frame("status"=c("raw dataset",
                              "NA",
                              "filtered dataset"),
                            "Number of metabolite"=c(length(names(dataset.raw.SE)),
                              length(names(dataset.raw.SE))-dim(na.omit(assay(dataset.SE)))[1],      length(names(dataset.SE))))
```

* The data were `r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata$transform_method` transformed.
* Summary of filtered metabolites.

```{r , echo=FALSE, message=TRUE, warning=TRUE}
DT::datatable(filt.summary, options = list(colnames=FALSE, rownames = FALSE, pageLength = 10, scrollX = T, dom = 'tip'),class = 'cell-border stripe')
```

### Distribution of density befor/after transformation

```{r densityPlotMeta, echo=FALSE, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}
Data_Distribution_Density.plot(dataset.raw.SE)
Data_Distribution_Density.plot(dataset.SE)
```

### Boxplot and Sum of XIC  

```{r libSize, echo=FALSE, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}
abundanceBoxplot(dataset.SE)
Library_size_barplot.plot(dataset.raw.SE)
```

### Principal component analysis

Multivariate quality check of design. For each design factor (one color for each), and each PCA axis this function plot the coordinates of the sample in a PCA axis (y-axis) in an increasing order along the x-axis. It allows to have a quick view of the percent of variability associated to each factor.

```{r PCAMetabo, echo=FALSE , fig.show="hold", message=FALSE, warning=FALSE,out.width = "100%", eval=FALSE}
mvQCdesign(object = FlomicsMultiAssay,
           data   = paste0(data,".filtred"), PCA="norm", axis=5, 
           pngFile= NULL) 
```

`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]])) {"\\begin{comment}"}`

## Differential expression 

Differential abundance of metabolites was carried out thanks to limma package.

 * The lmFit function was used to fit a linear model for each metabolites given the matrix
model constructed during the epxerimental design setup.

 * The selected contrasts were then computed from the fitted model and summary statistics were obtained via the contrasts.fit and eBayes functions (with the robust=T parameter). 

 * P-value of differential expressed metabolites were adjusted according to the `r dataset.SE@metadata[["DiffExpAnal"]]$Adj.pvalue.method` method
with a cutoff set to `r dataset.SE@metadata[["DiffExpAnal"]]$Adj.pvalue.cutoff`.


### Results summary


```{r DiffExprMetabo1,echo=FALSE,message=FALSE, out.width = "100%",warning=FALSE,  fig.show = "hold", eval=Diff.eval}

tmpRes <- dataset.SE@metadata[["DiffExpAnal"]]
DE <- vector()
DEup <- vector()
DEdown <- vector()

for (i  in  1:dim(tmpRes[["contrasts"]])[1]){
   contrastName <- tmpRes[["contrasts"]][i,]$contrastName
   #hyp <- tmpRes[["contrasts"]][i,]$tag
   stats <- tmpRes[["stats"]][[contrastName]]
   DE[i] <- stats$gDE
   DEup[i] <- paste(stats$gDEup," (",stats$pgDEup," %)",sep="")
   DEdown[i] <- paste(stats$gDEdown," (",stats$pgDEdown," %)",sep="")
}
```

```{r DiffExprMetabo2, echo=FALSE, results="asis", eval=Diff.eval}
kable_styling(kable(bind_cols(tmpRes[["contrasts"]][,c("tag","contrastName")], data.frame("Nb DE"=DE,"Nb DEup"=DEup,"Nb DEdown"=DEdown)), row.names=FALSE, caption=NULL, format="html"), font_size=12)
```


```{r DiffExprMetabo3,echo=FALSE, message=FALSE, warning=FALSE,  fig.show = "hold", out.width = "80%", echo=FALSE, eval=Diff.eval}

DEF_mat <- dataset.SE@metadata$DiffExpAnal[["mergeDEF"]]
UpSetR::upset(DEF_mat, sets = (names(DEF_mat[,-1]))) 

```


```{r DiffPerContMetabo, message=FALSE, warning=FALSE, echo=FALSE, echo=FALSE, message=TRUE, warning=TRUE, eval=Diff.eval}

  out <- NULL
  
  for (contrast  in  dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]]$contrastName) {
    
      out <- c(out, knitr::knit_child("report_04_diff_analysis_per_contrast.Rmd", quiet=TRUE))  
      
    }
    
knitr::asis_output(out)

```

`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]]))  {"\\begin{comment}"}`


`r if(is.null(dataset.SE@metadata[["CoExpAnal"]]$results)) {"\\end{comment}"}`

## Co-expression

Co-expression analysis was carried out on the `r dataset.SE@metadata[["CoExpAnal"]]$merge.type`
of the following list of metabolites `r dataset.SE@metadata$CoExpAnal$gene.list.names`. 
`r dataset.SE@metadata[["CoExpAnal"]]$tools` was
used to cluster them with the following parameters. The gaussian mixture models (`r paste0("model=",dataset.SE@metadata[["CoExpAnal"]]$GaussianModel,"")` was run on scaled by metabolite data to cluster them by expression profile rather than abundance.
`r dataset.SE@metadata[["CoExpAnal"]]$replicates.nb` technical replicates were performed with K=`r dataset.SE@metadata[["CoExpAnal"]]$K.range`. 
The best number of cluster (K) selected via the Integrated Completed Likelihood (ICL) criterion 
was `r dataset.SE@metadata[["CoExpAnal"]]$cluster.nb`.


```{r CoexpMeta, message=FALSE, warning=FALSE, echo=FALSE, message=TRUE, warning=TRUE, eval=CoEx.eval}

  out <- NULL
 
      out <- c(out, knitr::knit_child("report_05_coexp_analysis.Rmd", quiet=TRUE))  
    
knitr::asis_output(out)

```

`r  if(is.null(dataset.SE@metadata[["CoExpAnal"]]$results)) {"\\end{comment}"}`
