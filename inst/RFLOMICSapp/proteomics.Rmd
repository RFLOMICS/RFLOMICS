
# `r data` analysis

## Workflow of reference 

  To create the abundance matrix, tools from the Pappso platform (Gif sur Yvette) have been used for proteins identification and quantification.
  For the identification step XtandemPipeline was used (http://pappso.inrae.fr/bioinfo/xtandempipeline). For quantification two steps are required.
  First MassChroQ (http://pappso.inrae.fr/bioinfo/masschroq/) retrieves from the raw data the peptides intensities
  and then MassChroqR, a R package and script, finally computes the protein abundances, after many steps of peptides QC and filtering.


### Dataset processing

```{r CheckDesignProt, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}
check <- CheckExpDesignCompleteness(Design, colnames(FlomicsMultiAssay[[paste0(data,".filtrered")]]))
NbProt <- length(names(FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]))
NbProtWoutNA <- dim(na.omit(assay(FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]])))[1]
```

* X samples were removed from the datasets.
* The data were X transformed.
* The number of proteins: `r NbProt`  
* Number of proteins with at least 1 NA: `r NbProt - NbProtWoutNA`

### Distribution of density 

```{r densityPlotProt, echo=FALSE, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}
Data_Distribution_Density.plot(FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]])
```


### Principal component analysis

```{r PCAprot, echo=FALSE , fig.show="hold", message=FALSE, warning=FALSE,out.width = "80%"}
if(! is.null(FlomicsMultiAssay[[data]]@metadata[["PCAlist"]])){ 
mvQCdesign(object = FlomicsMultiAssay,
           data   = data, PCA="raw", axis=5, 
           pngFile= NULL) 
}
```


`r if(is.null(FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["DiffExpAnal"]][["contrasts"]])) {"\\begin{comment}"}`

## Differential expression 

Differential expression analysis was carried out for each selected contrast thanks to the `r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["DiffExpAnal"]]$method` model. 

P-value of differential expressed proteins were adjusted according to the `r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["DiffExpAnal"]]$Adj.pvalue.method` method
with a cutoff set to `r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["DiffExpAnal"]]$Adj.pvalue.cutoff`.

### Results summary

```{r DiffExprProteo1,echo=FALSE,message=FALSE, out.width = "100%",warning=FALSE,  fig.show = "hold"}

tmpRes <- FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["DiffExpAnal"]]
DE <- vector()
DEup <- vector()
DEdown <- vector()

for (i  in  1:dim(tmpRes[["contrasts"]])[1]){
   contrastName <- tmpRes[["contrasts"]][i,]$contrastName
   #hyp <- tmpRes[["contrasts"]][i,]$tag
   stats <- tmpRes[["stats"]][[contrastName]]
   DE[i] <- stats$gDE
   DEup[i] <- paste(stats$gDEup,"(",stats$pgDEup," %)",sep="")
   DEdown[i] <- paste(stats$gDEdown,"(",stats$pgDEdown," %)",sep="")
}

```

```{r DiffExprProteo2, echo=FALSE, results="asis"}
kable_styling(kable(bind_cols(tmpRes[["contrasts"]][,c("tag","contrastName")], data.frame("Nb DE"=DE,"Nb DEup"=DEup,"Nb DEdown"=DEdown)), row.names=TRUE, caption=NULL, format="html"),font_size=12)
```


```{r DiffExprProteo3,echo=FALSE, message=FALSE, warning=FALSE,  fig.show = "hold", out.width = "80%", echo=FALSE}

DEF_mat <- FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata$DiffExpAnal[["mergeDEF"]]
UpSetR::upset(DEF_mat, sets = (names(DEF_mat[,-1]))) 
```


```{r DiffPerContProteo, message=FALSE, warning=FALSE, echo=FALSE, echo=FALSE, message=TRUE, warning=TRUE}

  out <- NULL
  
  for (contrast  in  FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["DiffExpAnal"]][["contrasts"]]$contrastName) {
    
      out <- c(out, knitr::knit_child("DiffExpAnal_PerContrast.Rmd", quiet=TRUE))  
      
    }
    
knitr::asis_output(out)

```

`r  if(isFALSE(FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["CoExpAnal"]]$results))  {"\\end{comment}"}`


## Co-expression

Co-expression analysis was carried out on the `r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["CoExpAnal"]]$merge.type`
of the following list of proteins `r FlomicsMultiAssay[[paste0(data,".filtred")]]@metadata$CoExpAnal$gene.list.names`. 
`r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["CoExpAnal"]]$tools` was
used to cluster them with the following parameters. The gaussian mixture models (`r paste0("model=",FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["CoExpAnal"]]$GaussianModel,"")` was run on scaled by proteins data to cluster them by expression profile rather than abundance.
`r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["CoExpAnal"]]$replicates.nb` technical replicates were performed with K=`r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["CoExpAnal"]]$K.range`. 
The best number of cluster (K) selected via the Integrated Completed Likelihood (ICL) criterion 
was `r FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["CoExpAnal"]]$cluster.nb`.



```{r CoexpProt, message=FALSE, warning=FALSE, echo=FALSE, message=TRUE, warning=TRUE}

  out <- NULL
 
      out <- c(out, knitr::knit_child("CoExpAnal.Rmd", quiet=TRUE))  
    
knitr::asis_output(out)

```

`r  if(isFALSE(FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]@metadata[["CoExpAnal"]]$results)) {"\\end{comment}"}`

