
<!-- <details> -->

```{r , echo=FALSE , message=FALSE, warning=FALSE}

# TODO delete
# annot = 'DiffExpEnrichAnal' # TODO delete
# dataset.SE <- Flomics.MAE@ExperimentList$RNAseq.set1.filtred
# listname = names(dataset.SE@metadata[[annot]]$results_CPR)[1]
# domain = names(dataset.SE@metadata[[annot]]$results_CPR[[listname]])[1]
# TODO end delete

# create export data
listnameDir <- paste0(annotDir,"/", contrastName2contrastDir(listname),"/",domain,"/")
dir.create(path=listnameDir)

knitr::opts_chunk$set(
  fig.path=listnameDir
)
```

```{r}
log2FC_vect <- NULL
if(annot == 'DiffExpEnrichAnal'){
  log2FC_vect <- dataset.SE@metadata$DiffExpAnal$TopDEF[[listname]]$logFC
  names(log2FC_vect) <- rownames(dataset.SE@metadata$DiffExpAnal$TopDEF[[listname]])
}
```

### `r listname` {.tabset}

#### `r domain` {.tabset}

##### Result table

```{r results_table, echo=FALSE, out.width = "50%", message=FALSE, warning=FALSE,}
dataPlot <- dataset.SE@metadata[[annot]]$results_CPR[[listname]][[domain]]
DT::datatable(dataPlot@result[dataPlot@result$p.adjust < dataPlot@pvalueCutoff, ]%>% dplyr::select(!c("geneID", "qvalue")), # sometimes it prints non significant results...
                    rownames = FALSE,
                    options = list(rownames = FALSE, pageLength = 5, lengthMenu = c(5, 10, 15, 20), scrollX = T))

```

##### Dotplot

```{r dotplot_CPR, echo=FALSE, out.width = "50%", message=FALSE, warning=FALSE, fig.width = 7, fig.height = 7}
dataPlot <- dataset.SE@metadata[[annot]]$results_CPR[[listname]][[domain]]
dotplot(dataPlot, showCategory = 15) + 
  ggtitle(paste0(listname, "\nEnrichment analysis result on domain ", domain, "\nFirst 15 enriched terms"))
```

##### Heatplot

```{r dotplot_CPR, echo=FALSE, out.width = "50%", message=FALSE, warning=FALSE, fig.width = 12, fig.height = 7}
dataPlot <- dataset.SE@metadata[[annot]]$results_CPR[[listname]][[domain]]
 suppressMessages(print(# delete warnings for scale fill replacement
                                 heatplot(dataPlot, showCategory = 15, foldChange = log2FC_vect) + 
                                   labs(fill="log2FC") + 
                                   scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
                                   theme(axis.text.y = element_text(size = 10)) + 
                                   ggtitle(paste0(listname, " - Enrichment analysis result on domain ", domain, "\nFirst 15 enriched terms"))
                               ))
```


##### Cnetplot

```{r dotplot_CPR, echo=FALSE, out.width = "50%", message=FALSE, warning=FALSE, fig.width = 12, fig.height = 7}
dataPlot <- dataset.SE@metadata[[annot]]$results_CPR[[listname]][[domain]]
suppressMessages(print( # delete warnings for scale fill replacement
                               cnetplot(dataPlot, showCategory = 15, foldChange = log2FC_vect, node_label = "category") + 
                                 guides(colour=guide_colourbar(title = "log2FC")) +
                                 scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) + 
                                   ggtitle(paste0(listname, " - Enrichment analysis result on domain ", domain, "\nFirst 15 enriched terms"))
                             )) 
```

<!-- </details> -->



