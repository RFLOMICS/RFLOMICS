# `r data` 

```{r , echo=FALSE}

dataset.raw.SE <- FlomicsMultiAssay@ExperimentList[[data]]
dataset.SE     <- FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]

Diff.eval <- !is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]])
CoEx.eval <- !is.null(dataset.SE@metadata[["CoExpAnal"]]$results)
Diff.ann.eval <- !is.null(dataset.SE@metadata[["DiffExpAnal"]]$results)
CoEx.ann.eval <- !is.null(dataset.SE@metadata[["CoExpEnrichAnal"]]$results)

```

## Data pre-processing

* The *unexpressed genes* are filtered-out by default: `r length(dataset.raw.SE@metadata$rowSums.zero)` filtred-out genes.
* The *low expressed genes* (those with low counts) are filtred-out using the Counts Per Million (CPM) method with "`r dataset.SE@metadata$FilteringOptions$Filter_Strategy`" strategy and cut-off equal to `r dataset.SE@metadata$FilteringOptions$CPM_Cutoff`: `r length(dataset.raw.SE@metadata$FilteredFeatures)` filtred-out genes.

`r if(length(colnames(dataset.raw.SE)) - length(colnames(dataset.SE)) == 0) {"\\begin{comment}"}`

* The *outlier samples* are removed: `r setdiff(colnames(dataset.raw.SE), colnames(dataset.SE))`.

`r if(length(colnames(dataset.raw.SE)) - length(colnames(dataset.SE)) == 0) {"\\end{comment}"}`


```{r , echo=FALSE , message=FALSE, warning=FALSE, echo=FALSE, out.width = "70%"}

check <- CheckExpDesignCompleteness(FlomicsMultiAssay, colnames(FlomicsMultiAssay[[paste0(data,".filtred")]]))
check$plot

# filt.summary <-  data.frame("Status"=c("raw dataset",
#                               "0 count",
#                               "low count",
#                               "filtered sataset"),
#                             "Number of gene"=c(length(names(dataset.raw.SE)),
#                               length(dataset.raw.SE@metadata$rowSums.zero),
#                               length(dataset.SE@metadata$FilteredFeatures),
#                               length(names(dataset.SE))))
           
```

```{r, echo=FALSE, message=TRUE, warning=TRUE, eval=FALSE}
DT::datatable(filt.summary, options = list(colnames=FALSE, rownames = FALSE, pageLength = 10, scrollX = T, dom = 'tip'),class = 'cell-border stripe')
```

* The `r dataset.SE@metadata$Normalization$methode` normalization method 
was applied and the scaling factors are stored in the table below:

```{r , echo=FALSE, results="asis"}

DT::datatable(dataset.SE@metadata$Normalization$coefNorm, 
              options = list(rownames = TRUE, pageLength = 6, scrollX = T, dom = 'tip'),
              class = 'cell-border stripe')

# kable_styling(kable(dataset.SE@metadata$Normalization$coefNorm, row.names=FALSE, caption=NULL, format="html"), font_size=12,full_width = F, position = "left")

```

> QC plots

* Histograms of the library size before/after pre-processing

```{r , echo=FALSE, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}
Library_size_barplot.plot(dataset.raw.SE)
Library_size_barplot.plot(dataset.SE)
```

* Distribution of gene counts before/after pre-processing : boxplot

```{r , echo=FALSE, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}
Data_Distribution_plot(dataset.raw.SE, plot = "boxplot")
Data_Distribution_plot(dataset.SE, plot = "boxplot")
```

* Distribution of gene counts before/after pre-processing : density

```{r , echo=FALSE, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}
Data_Distribution_plot(dataset.raw.SE, plot = "density")
Data_Distribution_plot(dataset.SE, plot = "density")
```

* Principal component analysis before/after pre-processing

```{r , echo=FALSE , fig.show="hold", message=FALSE, warning=FALSE, out.width = "80%", eval=FALSE}

mvQCdesign(object = FlomicsMultiAssay,
           data   = paste0(data,".filtred"), PCA="norm", axis=5, 
           pngFile= NULL) 
```

```{r , echo=FALSE , fig.show="hold", message=FALSE, warning=FALSE, out.width = "50%"}

RFLOMICS::plotPCA(dataset.raw.SE, PCA="raw", PCs=c(1, 2), condition="groups")

RFLOMICS::plotPCA(dataset.SE, PCA="norm", PCs=c(1, 2), condition="groups")
```

```{r , echo=FALSE , fig.show="hold", message=FALSE, warning=FALSE, out.width = "50%"}

RFLOMICS::plotPCA(dataset.raw.SE, PCA="raw", PCs=c(1, 3), condition="groups")
RFLOMICS::plotPCA(dataset.SE, PCA="norm", PCs=c(1, 3), condition="groups")
```

`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]])) {"\\begin{comment}"}`

## Differential expression analysis

Differential expression analysis was carried out for each selected contrast thanks to the `r dataset.SE@metadata[["DiffExpAnal"]]$method` model. 

P-value of differential expressed genes were adjusted according to the `r dataset.SE@metadata[["DiffExpAnal"]]$Adj.pvalue.method` method
with a cutoff set to `r dataset.SE@metadata[["DiffExpAnal"]]$Adj.pvalue.cutoff`.

### Summary

```{r ,echo=FALSE,message=FALSE, out.width = "100%",warning=FALSE,  fig.show = "hold", eval=Diff.eval}

tmpRes <- dataset.SE@metadata[["DiffExpAnal"]]
DE <- vector()
DEup <- vector()
DEdown <- vector()

for (i  in  1:dim(tmpRes[["contrasts"]])[1]){
   contrastName <- tmpRes[["contrasts"]][i,]$contrastName
   #hyp <- tmpRes[["contrasts"]][i,]$tag
   stats <- tmpRes[["stats"]][[contrastName]]
   DE[i] <- stats$gDE
   DEup[i] <- paste(stats$gDEup,"(",stats$pgDEup," %)",sep="")
   DEdown[i] <- paste(stats$gDEdown,"(",stats$pgDEdown," %)",sep="")
}

```


```{r , echo=FALSE, results="asis", eval=Diff.eval}
kable_styling(kable(bind_cols(tmpRes[["contrasts"]][,c("tag","contrastName")], data.frame("Nb DE"=DE,"Nb DEup"=DEup,"Nb DEdown"=DEdown)), row.names=FALSE, caption=NULL, format="html"), font_size=12)

```


The following graph gives the number of common and specific differential expressed genes per testing hypothesis.



```{r ,echo=FALSE, message=FALSE, warning=FALSE, fig.show = "hold", out.width = "80%", echo=FALSE, eval=Diff.eval}
DEF_mat <- dataset.SE@metadata$DiffExpAnal[["mergeDEF"]]

if(dim(DEF_mat)[2] > 2){
  UpSetR::upset(DEF_mat, sets = (names(DEF_mat[,-1]))) 
}
```

<!-- ### Results per contrast -->

```{r , message=FALSE, warning=FALSE, echo=FALSE, eval=Diff.eval}

  out <- NULL
  
  for (contrast  in  dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]]$contrastName) {
      out <- c(out, knitr::knit_child(paste0(path.package("RFLOMICS"), "/RFLOMICSapp/","report_04_diff_analysis_per_contrast.Rmd"), quiet=TRUE))  
      
    }
    
knitr::asis_output(out)
```

`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]])) {"\\end{comment}"}`


`r if(is.null(dataset.SE@metadata[["CoExpAnal"]]$results))  {"\\begin{comment}"}`

```{r , message=FALSE, warning=FALSE, echo=FALSE, eval=CoEx.eval}

  out <- NULL
 
  out <- c(out, knitr::knit_child(paste0(path.package("RFLOMICS"), "/RFLOMICSapp/","report_05_coexp_analysis.Rmd"), quiet=TRUE))  
    
knitr::asis_output(out)

```

`r if(is.null(dataset.SE@metadata[["CoExpAnal"]]$results)) {"\\end{comment}"}`

`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]]$results) && is.null(dataset.SE@metadata[["CoExpEnrichAnal"]]$results)) {"\\begin{comment}"}`

## Annotation and Enrichment

The Enrichment are performed using hypergeometric tests to find annotation terms that are specifically over or under-represented in a given list of genes with respect to a reference specified by an annotation file.

`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]]$results)) {"\\begin{comment}"}`

* On the lists of differential expressed genes

```{r , message=FALSE, warning=FALSE, echo=FALSE}

  out <- NULL
  
  annot <- "DiffExpEnrichAnal"
  
  for (listname  in  names(dataset.SE@metadata[[annot]]$results)){
      out <- c(out, knitr::knit_child(paste0(path.package("RFLOMICS"), "/RFLOMICSapp/","report_06_annot_enrich_per_list.Rmd"), quiet=TRUE))
  }
    
knitr::asis_output(out)

```

`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]]$results)) {"\\end{comment}"}`

`r if(is.null(dataset.SE@metadata[["CoExpEnrichAnal"]]$results)) {"\\begin{comment}"}`


* On the co-expressed gene clusters

```{r , message=FALSE, warning=FALSE, echo=FALSE}

  out <- NULL
  
  annot <- "CoExpEnrichAnal"

  for (listname  in  names(dataset.SE@metadata[[annot]]$results)){
      out <- c(out, knitr::knit_child(paste0(path.package("RFLOMICS"), "/RFLOMICSapp/","report_06_annot_enrich_per_list.Rmd"), quiet=TRUE))
  }
    
knitr::asis_output(out)

```

`r if(is.null(dataset.SE@metadata[["CoExpEnrichAnal"]]$results)) {"\\end{comment}"}`


`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]]$results) && is.null(dataset.SE@metadata[["CoExpEnrichAnal"]]$results))  {"\\end{comment}"}`

