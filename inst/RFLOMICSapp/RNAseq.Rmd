# `r data` analysis

```{r , echo=FALSE}

dataset.raw.SE <- FlomicsMultiAssay@ExperimentList[[data]]
dataset.SE     <- FlomicsMultiAssay@ExperimentList[[paste0(data,".filtred")]]

Diff.eval <- !is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]])
CoEx.eval <- !is.null(dataset.SE@metadata[["CoExpAnal"]]$results)
Annt.eval <- !is.null(dataset.SE@metadata[["EnrichAnal"]]$results)

```


## Workflow of reference 

DiCoExpress [@Lambert:2020ta]

## Description of dataset's processing


```{r , fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE, echo=FALSE}

check <- CheckExpDesignCompleteness(FlomicsMultiAssay@metadata$design, colnames(dataset.SE))
check$plot


NbGenes             <- length(names(dataset.raw.SE))
NbGene.rowSums.zero <- length(dataset.raw.SE@metadata$rowSums.zero)
NbGene.low.counts   <- length(dataset.SE@metadata$FilteredFeatures)
```

### Filtering:

* By default, gene with 0 count are removed from the data. 
* The choosen filtering strategy is `r dataset.SE@metadata$FilteringOptions$Filter_Strategy` with a count per million of read (CPM) cut-off of `r dataset.SE@metadata$FilteringOptions$CPM_Cutoff`  
* The number of genes: `r NbGenes`  
* Number of genes with zero count: `r NbGene.rowSums.zero`
* Number of genes filtered: `r NbGene.low.counts`

### Normalization:

The `r dataset.SE@metadata$Normalization$methode` normalization method 
was applied and the scaling factors are stored in the table below:

```{r , echo=FALSE, results="asis"}

DT::datatable(dataset.SE@metadata$Normalization$coefNorm, 
              options = list(rownames = FALSE, pageLength = 10, scrollX = T, dom = 'tip'),
              class = 'cell-border stripe')

# kable_styling(kable(dataset.SE@metadata$Normalization$coefNorm, row.names=FALSE, caption=NULL, format="html"), font_size=12,full_width = F, position = "left")

```

### Distribution of library size befor/after processing

```{r , echo=FALSE, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}
Library_size_barplot.plot(dataset.raw.SE)
Library_size_barplot.plot(dataset.SE)
```

### Distribution of density befor/after processing

```{r , echo=FALSE, fig.show = "hold", out.width = "50%", message=FALSE, warning=FALSE}

Data_Distribution_Density.plot(dataset.raw.SE)
Data_Distribution_Density.plot(dataset.SE)
```


### Principal component analysis befor/after processing

```{r , echo=FALSE , fig.show="hold", message=FALSE, warning=FALSE, out.width = "80%", eval=FALSE}
#mvQCdesign(object = FlomicsMultiAssay,
#           data   = data, PCA="raw", axis=5, 
#           pngFile= NULL) 
mvQCdesign(object = FlomicsMultiAssay,
           data   = paste0(data,".filtred"), PCA="norm", axis=5, 
           pngFile= NULL) 
```



`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]])) {"\\begin{comment}"}`

## Differential expression analysis

Differential expression analysis was carried out for each selected contrast thanks to the `r dataset.SE@metadata[["DiffExpAnal"]]$method` model. 

P-value of differential expressed genes were adjusted according to the `r dataset.SE@metadata[["DiffExpAnal"]]$Adj.pvalue.method` method
with a cutoff set to `r dataset.SE@metadata[["DiffExpAnal"]]$Adj.pvalue.cutoff`.

### Summary

```{r ,echo=FALSE,message=FALSE, out.width = "100%",warning=FALSE,  fig.show = "hold", eval=Diff.eval}

tmpRes <- dataset.SE@metadata[["DiffExpAnal"]]
DE <- vector()
DEup <- vector()
DEdown <- vector()

for (i  in  1:dim(tmpRes[["contrasts"]])[1]){
   contrastName <- tmpRes[["contrasts"]][i,]$contrastName
   #hyp <- tmpRes[["contrasts"]][i,]$tag
   stats <- tmpRes[["stats"]][[contrastName]]
   DE[i] <- stats$gDE
   DEup[i] <- paste(stats$gDEup,"(",stats$pgDEup," %)",sep="")
   DEdown[i] <- paste(stats$gDEdown,"(",stats$pgDEdown," %)",sep="")
}

```


```{r , echo=FALSE, results="asis", eval=Diff.eval}
kable_styling(kable(bind_cols(tmpRes[["contrasts"]][,c("tag","contrastName")], data.frame("Nb DE"=DE,"Nb DEup"=DEup,"Nb DEdown"=DEdown)), row.names=FALSE, caption=NULL, format="html"), font_size=12)

```


The following graph gives the number of common and specific differential expressed genes per testing hypotethis.



```{r ,echo=FALSE, message=FALSE, warning=FALSE, fig.show = "hold", out.width = "80%", echo=FALSE, eval=Diff.eval}
DEF_mat <- dataset.SE@metadata$DiffExpAnal[["mergeDEF"]]

if(dim(DEF_mat)[2] > 2){
  UpSetR::upset(DEF_mat, sets = (names(DEF_mat[,-1]))) 
}
```

### Results per contrast

```{r , message=FALSE, warning=FALSE, echo=FALSE, eval=Diff.eval}

  out <- NULL
  
  for (contrast  in  dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]]$contrastName) {
    
      out <- c(out, knitr::knit_child("DiffExpAnal_PerContrast.Rmd", quiet=TRUE))  
      
    }
    
knitr::asis_output(out)
```

`r if(is.null(dataset.SE@metadata[["DiffExpAnal"]][["contrasts"]])) {"\\end{comment}"}`

`r if(is.null(dataset.SE@metadata[["CoExpAnal"]]$results))  {"\\begin{comment}"}`


## Co-expression

Co-expression analysis was carried out on the `r dataset.SE@metadata[["CoExpAnal"]]$merge.type`
of the following list of gene `r dataset.SE@metadata$CoExpAnal$gene.list.names`. 
`r dataset.SE@metadata[["CoExpAnal"]]$tools` was
used to cluster genes. 
The gaussian mixture model was run on filtered (meanFilterCutoff was set to: `r dataset.SE@metadata[["CoExpAnal"]]$meanFilterCutoff`), 
normalised (normalisation method was `r dataset.SE@metadata[["CoExpAnal"]]$normFactors`) 
and transformed (transformation method: `r dataset.SE@metadata[["CoExpAnal"]]$transformation`) count data.
`r dataset.SE@metadata[["CoExpAnal"]]$replicates.nb` technical replicates were performed for each K in `r dataset.SE@metadata[["CoExpAnal"]]$K.range` (K=number of clusters). 
The best number of cluster (K) selected via the Integrated Completed Likelihood (ICL) criterion 
was `r dataset.SE@metadata[["CoExpAnal"]]$cluster.nb`.

```{r , message=FALSE, warning=FALSE, echo=FALSE, eval=CoEx.eval}

  out <- NULL
 
  out <- c(out, knitr::knit_child("CoExpAnal.Rmd", quiet=TRUE))  
    
knitr::asis_output(out)

```

`r if(is.null(dataset.SE@metadata[["CoExpAnal"]]$results)) {"\\end{comment}"}`

`r if(is.null(dataset.SE@metadata[["EnrichAnal"]]$results)) {"\\begin{comment}"}`

## Annotation and Enrichment

### Summary


### Results per gene list

```{r , message=FALSE, warning=FALSE, echo=FALSE,  eval=Annt.eval}

  out <- NULL
  
  for (listname  in  names(dataset.SE@metadata[["EnrichAnal"]]$results)){
    
      out <- c(out, knitr::knit_child("EnrichAnal_PerList.Rmd", quiet=TRUE))  
      
    }
    
knitr::asis_output(out)

```

`r if(is.null(dataset.SE@metadata[["EnrichAnal"]]$results))  {"\\end{comment}"}`

