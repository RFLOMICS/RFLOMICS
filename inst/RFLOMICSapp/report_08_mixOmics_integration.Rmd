## `r selectedResponse` 

```{r setup, include = FALSE, hide = TRUE, eval = TRUE}
explorDir <- paste0(outDir,"/","Integration/MixOmics/", selectedResponse, "/")
dir.create(path = explorDir)

knitr::opts_chunk$set(fig.path = explorDir)
```

```{r}
Data_res <- set_res <- NULL
Data_res <- RFLOMICS::getMixOmics(rflomics.MAE, response = selectedResponse)
set_res  <- RFLOMICS::getMixOmicsSettings(rflomics.MAE)
ncompDat <- min(Data_res$ncomp, 5)
fig_height <- NULL
fig_height <- ceiling(length(set_res$selectData)/2)*4.5
fig_width <- 15
nrow_plot <- ceiling(length(set_res$selectData)/2)
```

### Overview

```{r mixOmics_overview}
if (is.list(Data_res$X)) {
    # block.plsda or block.splsda
    df <- t(vapply(Data_res$X, dim, c(1, 1)))
    colnames(df) <- c("Ind", "Features")
    
    if (set_res$sparsity) {
        df <- cbind(df, do.call("rbind", Data_res$keepX))
        colnames(df)[!colnames(df) %in% c("Ind", "Features")] <-
            paste("Comp", seq_len(length(Data_res$keepX[[1]])))
    }
    
} else {
    # plsda or splsda
    df <-  data.frame("Ind" = nrow(Data_res$X),
                      "Features" = ncol(Data_res$X))
    if (set_res$sparsity) {
        df <- cbind(df, do.call("cbind", as.list(Data_res$keepX)))
        colnames(df)[!colnames(df) %in% c("Ind", "Features")] <-
            paste("Comp", seq_len(length(Data_res$keepX)))
    }
}

DT::datatable(t(df), options = list(dom = 't'))
```

```{r mixOmics_varExp, fig.width = 12, fig.height = 5}
RFLOMICS:::plotMOVarExp(rflomics.MAE, selectedResponse = selectedResponse)
```

### Idividuals plots {.tabset}

```{r, results="asis", fig.height = fig_height, fig.width=fig_width, fig.align = "center"}
childTest <- NULL
outMixOmics <- NULL

for (i in seq_len(ncompDat - 1)) {
    outMixOmics <- c(outMixOmics,
                 paste0("\n#### Comp ", i, " - ", i + 1, "\n"))
    
    childTest <-  c(
        "```{r, fig.width = fig_width, fig.height = fig_height}\n",
        "mixOmics::plotIndiv(Data_res, comp = c(i, i + 1), 
                                  ellipse = FALSE, legend = TRUE)",
        "```\n")
    outMixOmics <- c(outMixOmics, knitr::knit_child(text = childTest,
                                            envir = environment(),
                                            quiet = TRUE))
}
knitr::asis_output(outMixOmics)

```

### Loadings {.tabset}

```{r, results="asis", fig.height = fig_height, fig.width=fig_width, fig.align = "center"}
childTest <- NULL
outMixOmics <- NULL

for (i in seq_len(ncompDat)) {
    outMixOmics <- c(outMixOmics,
                 paste0("\n#### Comp ", i, "\n"))
    
    childTest <-  c(
        "```{r, fig.width = fig_width, fig.height = fig_height}\n",
        "mixOmics::plotLoadings(Data_res, 
                       comp = i,
                       ndisplay = 15, layout = c(nrow_plot, 2),
                       size.name = 1.2, size.legend = 1.2) ",
        "```\n")
    outMixOmics <- c(outMixOmics, knitr::knit_child(text = childTest,
                                            envir = environment(),
                                            quiet = TRUE))
}
knitr::asis_output(outMixOmics)

```

---

<!-- Exports -->

```{r mixOmics_export}
loads <- do.call("rbind", lapply(names(Data_res$loadings), FUN = function(nam){
    df <- data.frame(Data_res$loadings[[nam]])
    df$Table <- nam
    dplyr::relocate(df, Table)
}
))

write.table(loads, 
            file = paste0(explorDir, selectedResponse, "_Loading_values.txt"),
            sep = "\t", quote = FALSE, col.names = TRUE, row.names = TRUE)

inds <- do.call("rbind", lapply(names(Data_res$variates), FUN = function(nam){
    df <- data.frame(Data_res$variates[[nam]])
    df$Table <- nam
    dplyr::relocate(df, Table)
}
))

write.table(inds, file = paste0(explorDir, selectedResponse, "_Ind_coord.txt"),
            sep = "\t", quote = FALSE, col.names = TRUE, row.names = TRUE)
```


