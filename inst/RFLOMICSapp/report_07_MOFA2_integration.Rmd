
```{r MOFA_chunkoptions, include = FALSE, hide = TRUE, eval = TRUE}
explorDir <- paste0(outDir,"/","Integration/MOFA2/")
dir.create(path = explorDir)

knitr::opts_chunk$set(fig.path = explorDir)
```

```{r MOFA_extract}
MOFARes <- MOFAset <- NULL
MOFARes <- RFLOMICS::getMOFA(rflomics.MAE)
MOFAset <- RFLOMICS::getMOFASettings(rflomics.MAE)
```


```{r}
fig_width <- 15
fig_height <- ceiling(length(MOFA2::views_names(MOFARes))/2)*4.5
```

## Settings

* MOFA2  R package was used to perform data unsupervised integration, on <span style="color:blue">`r paste(MOFA2::views_names(MOFARes), collapse = ", ")`</span> datatables.
* Taking the <span style="color:blue">`r rflomics.MAE@metadata$IntegrationAnalysis[["MOFA"]]$MOFA_selected_filter`</span> of lists of DE features lead to the following analysis setting: 

```{r MOFA2_data_overview, fig.width=6.5, fig.height = 5, fig.align="center"}
MOFA2::plot_data_overview(MOFARes)
```

* Options for the run:
  * Scale views: `r MOFAset$scale_views` 
  * Number of factors: `r MOFAset$num_factors`. Obtained number of factors: `r MOFA2::get_dimensions(MOFARes)$K`
  * Number of iterations: `r MOFAset$maxiter` 
* RNASeq data were transformed using <span style="color:DarkOrchid">voom</span> transformation from limma package 
* Batch effects `r paste(RFLOMICS::getBatchFactors(rflomics.MAE), collapse = ", ")`  were corrected using <span style="color:DarkOrchid">removebatcheffect</span> function from limma package.

##  Results

### Correlation between factors

```{r}
mat_cor <- stats::cor(MOFA2::get_factors(MOFARes)[[1]])
mat_cor <- mat_cor - diag(mat_cor)
```

* Number of computed factors: `r MOFARes@dimensions$K` 
* Is there a correlation >0.5 between two factors? `r ifelse(any(mat_cor>0.5), "YES, be careful, the results are unreliable.", "No.")`

```{r MOFA2_factor_cor, fig.width=4.5, fig.height = 4, fig.align="center"}
MOFA2::plot_factor_cor(MOFARes)
```

### Explained Variance

```{r explained_variance, fig.width = 10, fig.height = 4, fig.align = "center"}
# compute both per factor and per table by default.
g1 <- MOFA2::plot_variance_explained(MOFARes, plot_total = TRUE)[[2]] + 
    ggplot2::ggtitle("Total explained variance per omic data")
g2 <- MOFA2::plot_variance_explained(MOFARes, x = "view", y = "factor") + 
    ggplot2::ggtitle("Explained variance by factors and omic data")

ggpubr::ggarrange(g1, g2, ncol = 2)
```

### Weights of the factors explaining the most variance {.tabset}

The following image shows the weights of the features for each table and each factors for all factors that explain at least 5\% of the variance in any table. 

```{r}
VarExp = MOFA2::get_variance_explained(MOFARes)$r2_per_factor$group1
FactNum = apply(VarExp, 1, FUN = function(vect) any(vect > 5)) # Percentage
```

```{r, fig.height = fig_height, fig.width=fig_width, fig.align = "center"}
ggplot_list <- list()
for (i in which(FactNum)) {
    ggplot_sublist <- list()
    for (j in MOFA2::views_names(MOFARes)) {
        
        ggplot_sublist[[length(ggplot_sublist) + 1]] <- MOFA2::plot_top_weights(MOFARes,
                                                                                view = j,
                                                                                factors = i,
                                                                                nfeatures = 10, 
                                                                                scale = TRUE) + 
            ggplot2::ggtitle(paste0(j, " - Factor ", i))
    }
    ggplot_list[[length(ggplot_list) + 1]] <- ggpubr::ggarrange(plotlist = ggplot_sublist, 
                                                        ncol = 2)
}
```

#### Factor 1

```{r MOFA2_weightfactors1, fig.width = fig_width}
ggplot_list[[1]]
```

#### Factor 2

```{r MOFA2_weightfactors2, fig.width = fig_width}
ggplot_list[[2]]
```

`r if(sum(FactNum)<3) {"\\begin{comment}"}`

#### Factor 3

```{r MOFA2_weightfactors3, fig.width = fig_width}
ggplot_list[[3]]
```

`r if(sum(FactNum)<3) {"\\end{comment}"}`


`r if(sum(FactNum)<4) {"\\begin{comment}"}`

#### Factor 4

```{r MOFA2_weightfactors4, fig.width = fig_width}
ggplot_list[[4]]
```

`r if(sum(FactNum)<4) {"\\end{comment}"}`

`r if(sum(FactNum)<5) {"\\begin{comment}"}`

#### Factor 5

```{r MOFA2_weightfactors5, fig.width = fig_width}
ggplot_list[[5]]
```

`r if(sum(FactNum)<5) {"\\end{comment}"}`

### Heatmaps {.tabset}

For all views, these heatmap show the 10 first features in term of weights for the factors explaining at least 5\% variance in any table.

```{r, fig.width = 15, fig.height = 5, fig.show = "hold", include = FALSE, fig.keep = "none"}
list_heat_views <- list()
list_arrange <- list()
for (fac in 1:MOFARes@dimensions$K) {
    list_heat_views[[fac]] <- list()
    for (nam in MOFA2::views_names(MOFARes)) {
        list_heat_views[[fac]][[nam]] <- NULL
        png(file = "temp.png")
        list_heat_views[[fac]][[nam]] <- MOFA2::plot_data_heatmap(MOFARes, 
                                                                  view = nam, 
                                                                  factor = fac, 
                                                                  features = 10, 
                                                                  main = paste0(nam, " - Factor ", fac), 
                                                                  cellheight = 20, 
                                                                  cellwidth = 12)
        dev.off()
        invisible(file.remove("temp.png"))
    }
    list_arrange[[fac]] <- gridExtra::grid.arrange(grobs = lapply(list_heat_views[[fac]], FUN = function(object) object$gtable),
                                                   ncol = 2)
}
dev.off()
```

#### Factor 1

```{r MOFA2_heatmap1, fig.width = fig_width}
ggpubr::as_ggplot(list_arrange[[1]])
```

#### Factor 2

```{r MOFA2_heatmap2, fig.width = fig_width}
ggpubr::as_ggplot(list_arrange[[2]])
```

`r if(sum(FactNum)<3) {"\\begin{comment}"}`

#### Factor 3

```{r MOFA2_heatmap3, fig.width = fig_width}
ggpubr::as_ggplot(list_arrange[[3]])
```

`r if(sum(FactNum)<3) {"\\end{comment}"}`


`r if(sum(FactNum)<4) {"\\begin{comment}"}`

#### Factor 4

```{r MOFA2_heatmap3, fig.width = fig_width}
ggpubr::as_ggplot(list_arrange[[4]])
```

`r if(sum(FactNum)<4) {"\\end{comment}"}`

`r if(sum(FactNum)<5) {"\\begin{comment}"}`

#### Factor 5

```{r MOFA2_heatmap3, fig.width = fig_width}
ggpubr::as_ggplot(list_arrange[[5]])
```

`r if(sum(FactNum)<5) {"\\end{comment}"}`

# {.unlisted .unnumbered}

---

```{r MOFA2_export}
write.table(MOFA2::get_factors(MOFARes, as.data.frame = TRUE),
            file = paste0(explorDir, "Factors_values.txt"),
            sep = "\t", quote = FALSE, col.names = TRUE, row.names = TRUE)
write.table(MOFA2::get_weights(MOFARes, as.data.frame = TRUE),
            file = paste0(explorDir, "Factors_weights.txt"),
            sep = "\t", quote = FALSE, col.names = TRUE, row.names = TRUE)
```

