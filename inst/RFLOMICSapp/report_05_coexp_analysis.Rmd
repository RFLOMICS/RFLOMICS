---
editor_options: 
  markdown: 
    wrap: 72
---

## Co-expression {.tabset}

```{r , echo=FALSE , message=FALSE, warning=FALSE}
coexpDir <- paste0(dataDir,"/","03-Coexpression_analysis/")
dir.create(path=coexpDir)

knitr::opts_chunk$set(
  fig.path=coexpDir
)

isResults <- dataset.SE@metadata$CoExpAnal[["results"]]
```

`r if(RFLOMICS::getOmicsTypes(dataset.raw.SE) != "RNAseq") {"\\begin{comment}"}`
Co-expression analysis strategy was adapted from @Lambert2020ta
`r if(RFLOMICS::getOmicsTypes(dataset.raw.SE) != "RNAseq") {"\\end{comment}"}`

Co-expression analysis was carried out on the
`r RFLOMICS::getCoexpSettings(dataset.SE)$merge.type` of the following list of
`r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]`
`r names(RFLOMICS::getCoexpSettings(dataset.SE)$gene.list.names)`.
`r RFLOMICS::getCoexpSettings(dataset.SE)$method` was used to cluster the
`r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]`.

The gaussian mixture model was run on filtered (meanFilterCutoff was set
to: `r RFLOMICS::getCoexpSettings(dataset.SE)$meanFilterCutoff`), normalized
(normalization method was `r RFLOMICS::getCoexpSettings(dataset.SE)$normFactors`)
and transformed (transformation method:
`r RFLOMICS::getCoexpSettings(dataset.SE)$transformation`) count data.

`r RFLOMICS::getCoexpSettings(dataset.SE)$replicates.nb` technical replicates were
performed for each K in `r RFLOMICS::getCoexpSettings(dataset.SE)$K.range`
(K=number of clusters).

The best number of cluster (K) selected via the Integrated Completed
Likelihood (ICL) criterion was
`r metadata(dataset.SE)[["CoExpAnal"]]$cluster.nb`.

`r if(isResults == TRUE) {"\\begin{comment}"}` No clustering results.
`r if(isResults == TRUE) {"\\end{comment}"}`

### ICL

*Integrated Completed Likelihood (ICL) plotted versus number of clusters.The ICL is the criterion used to select the number of clusters. The number of clusters (K) that minmizes the ICL is the best number of clusters.*

```{r coseq-icl, echo=FALSE, eval=isResults}
plot.coseq.res <- plotCoExpression(dataset.SE)
par(mar = c(4, 4, .5, .1))
plot.coseq.res$ICL 
```

### probapost_boxplots

*Barplots giving a quality control of each cluster. In green: number of* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *that are member of a cluster with a high confidance (Max Conditional Probability  > 0.8). In purple:  number of* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *that are member of a cluster with a low confidance (Max Conditional Probability < 0.8). A high proportion of green observations may indicate that the clustering is not reliable and can't be exploited.*

```{r coseq-probapost, echo=FALSE, eval=isResults}
par(mar = c(4, 4, .5, .1))
plot.coseq.res$probapost_barplots 
```

### boxplots

*Overview of cluster's expression profiles. Boxplot are colored acording to  biological  factors*

```{r coseq-boxplots, echo=FALSE, eval=isResults}
par(mar = c(4, 4, .5, .1))
plot.coseq.res$boxplots + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))
```

### Cluster composition:

```{r coseq-clusterComposition, echo=FALSE, eval=isResults}
par(mar = c(4, 4, .5, .1))
plotCoseqContrasts(dataset.SE)
```


```{r,echo = FALSE, eval=isResults}

cosRes <- metadata(dataset.SE)$CoExpAnal$coseqResults@allResults
tab.clusters <- as.data.frame(cosRes[[which(names(cosRes) == names(metadata(dataset.SE)$CoExpAnal$cluster.nb))]])
tab.clusters <- tibble::rownames_to_column(tab.clusters, var = "DEF")
      
write.table(tab.clusters,
             file=paste0(coexpDir,"Table_of_DE_", RFLOMICS:::omicsDic(dataset.SE)[["variableName"]],"_per_cluster",".txt"),
             sep="\t",quote=FALSE,col.names=TRUE,row.names=FALSE)

```

## {-}
