## Co-expression {.tabset}

```{r , echo=FALSE , message=FALSE, warning=FALSE}
coexpDir <- paste0(dataDir,"/","03-Coexpression_analysis/")
dir.create(path=coexpDir)

knitr::opts_chunk$set(
  fig.path=coexpDir
)

isResults <- dataset.SE@metadata$CoExpAnal[["results"]]
```

`r if(dataset.raw.SE@metadata$omicType != "RNAseq") {"\\begin{comment}"}`
Co-expression analysis strategy was adapted from @Lambert2020ta
`r if(dataset.raw.SE@metadata$omicType != "RNAseq") {"\\end{comment}"}`

Co-expression analysis was carried out on the `r getCoexpSetting(dataset.SE)$merge.type`
of the following list of `r RFLOMICS:::omicsDic(dataset.SE)[["variableName"]]`  `r names(getCoexpSetting(dataset.SE)$gene.list.names)`. 
`r getCoexpSetting(dataset.SE)$method` was used to cluster the `r RFLOMICS:::omicsDic(dataset.SE)[["variableName"]]`. 

The gaussian mixture model was run on filtered (meanFilterCutoff was set to: `r getCoexpSetting(dataset.SE)$meanFilterCutoff`), 
normalized (normalization method was `r getCoexpSetting(dataset.SE)$normFactors`) 
and transformed (transformation method: `r getCoexpSetting(dataset.SE)$transformation`) count data.

`r getCoexpSetting(dataset.SE)$replicates.nb` technical replicates were performed for each K in `r getCoexpSetting(dataset.SE)$K.range` (K=number of clusters). 

The best number of cluster (K) selected via the Integrated Completed Likelihood (ICL) criterion 
was `r dataset.SE@metadata[["CoExpAnal"]]$cluster.nb`.


`r if(isResults == TRUE) {"\\begin{comment}"}`
No clustering results.
`r if(isResults == TRUE) {"\\end{comment}"}`


### ICL 

**Integrated Completed Likelihood (ICL) plotted versus number of clusters**

```{r coseq-icl, echo=FALSE, eval=isResults}
plot.coseq.res <- plotCoExpression(dataset.SE)
par(mar = c(4, 4, .5, .1))
plot.coseq.res$ICL 
```


### probapost_boxplots 

**number of observations with a maximum conditional probability greater than threshold (0.8) per cluster**

```{r coseq-probapost, echo=FALSE, eval=isResults}
par(mar = c(4, 4, .5, .1))
plot.coseq.res$probapost_barplots 
```

### boxplots

```{r coseq-boxplots, echo=FALSE, eval=isResults}
par(mar = c(4, 4, .5, .1))
plot.coseq.res$boxplots + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))
```

```{r ,echo=FALSE, eval=isResults}

```




```{r,echo = FALSE, eval=isResults}

cosRes <- dataset.SE@metadata$CoExpAnal$coseqResults@allResults
tab.clusters <- as.data.frame(cosRes[[which(names(cosRes) == names(dataset.SE@metadata$CoExpAnal$cluster.nb))]])
tab.clusters <- tibble::rownames_to_column(tab.clusters, var = "DEF")
      
write.table(tab.clusters,
             file=paste0(coexpDir,"Table_of_DE_", RFLOMICS:::omicsDic(dataset.SE)[["variableName"]],"_per_cluster",".txt"),
             sep="\t",quote=FALSE,col.names=TRUE,row.names=FALSE)

```
