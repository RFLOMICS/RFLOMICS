<!-- # --- -->
<!-- # title: "MOFA2_integration" -->
<!-- # output: html_document -->
<!-- # --- -->
<!-- #  -->
<!-- # ```{r setup, include=FALSE} -->
<!-- # knitr::opts_chunk$set(cache = FALSE, echo = FALSE) -->
<!-- # ``` -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # load("/home/ahulot/Documents/INRAE/Projets/rflomics/inst/ExamplesFiles/FlomicsMultiAssay.RData") -->
<!-- # # library(ggplot) -->
<!-- # ``` -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # if(is.null(FlomicsMultiAssay@metadata$MOFA_results)){print("Faire en sorte que Ã§a ne compile pas.")} -->
<!-- # ``` -->

# MOFA Integration

## Settings

<!-- * Chosen contrasts and chosen datatables -->
<!-- * Union or intersection of the lists of genes -->
<!-- * Number of features per datatable (MOFA overview) -->
<!-- * Scale views or not -->
<!-- * Number of factors asked, number of factors computed by MOFA -->
<!-- * Reference for the package and associated paper -->
<!-- * Associated graphs for the first 3 factors ? (Heatmap are way too big for this kind of things.) -->

* MOFA2  R package was used to perform data unsupervised integration, on <span style="color:blue">`r paste(MOFA2::views_names(FlomicsMultiAssay@metadata$MOFA_results), collapse = ", ")`</span> datatables.
* Selected contrasts: `r cat(paste(paste0("\t * ", FlomicsMultiAssay@metadata$MOFA_selected_contrasts), collapse = " \n "))` 
<!-- TODO The above does not work... -->
* Taking the <span style="color:blue">`r FlomicsMultiAssay@metadata$MOFA_selected_filter`</span> of lists of DE features lead to the following analysis setting: 

```{r, fig.width=6.5, fig.height = 5, fig.align="center"}
MOFA2::plot_data_overview(FlomicsMultiAssay@metadata$MOFA_results)
```

* Options for the run:
  * Scale views: `r FlomicsMultiAssay@metadata$MOFA_untrained@data_options$scale_views` 
  * Number of factors: `r FlomicsMultiAssay@metadata$MOFA_untrained@model_options$num_factors` 
  * Number of iterations: `r FlomicsMultiAssay@metadata$MOFA_untrained@training_options$maxiter` 
* RNASeq data were transformed using <span style="color:DarkOrchid">voom</span> transformation from limma package 
* Batch effects`r FlomicsMultiAssay@metadata$MOFA_untrained@training_options$maxiter`  were corrected using <span style="color:DarkOrchid">removebatcheffect</span> function from limma package.

##  Results

```{r}
mat_cor <- cor(MOFA2::get_factors(FlomicsMultiAssay@metadata$MOFA_results)[[1]])
mat_cor <- mat_cor - diag(mat_cor)
```

* Number of computed factors: `r FlomicsMultiAssay@metadata$MOFA_results@dimensions$K` 
* Is there a correlation >0.5 between two factors? `r ifelse(any(mat_cor>0.5), "YES, be careful, the results are unreliable.", "No.")`

```{r, fig.width=4.5, fig.height = 4, fig.align="center"}
MOFA2::plot_factor_cor(FlomicsMultiAssay@metadata$MOFA_results)
```

```{r, fig.width = 10, fig.height = 4, fig.align = "center"}
g1 <- MOFA2::plot_variance_explained(FlomicsMultiAssay@metadata$MOFA_results, plot_total = TRUE)[[2]] + # compute both per factor and per table by default.
  ggplot2::ggtitle("Total explained variance per omic data")
g2 <- MOFA2::plot_variance_explained(FlomicsMultiAssay@metadata$MOFA_results, x = "view", y = "factor") + ggplot2::ggtitle("Explained variance by factors and omic data")

ggpubr::ggarrange(g1, g2, ncol = 2)
```
```{r}
VarExp = MOFA2::get_variance_explained(FlomicsMultiAssay@metadata$MOFA_results)$r2_per_factor$group1
FactNum = apply(VarExp, 1, FUN = function(vect) any(vect>5)) # Percentage
f.height = 5+0.5*length(which(FactNum))
f.width = 5+2*length(MOFA2::views_names(FlomicsMultiAssay@metadata$MOFA_results))
# f.width = 15
# f.height = 15
```

```{r, fig.height = f.height, fig.width=f.width, fig.align = "center"}
ggplot_list <- list()
for(i in which(FactNum)){
  for(j in MOFA2::views_names(FlomicsMultiAssay@metadata$MOFA_results)){
    ggplot_list[[length(ggplot_list)+1]] <- MOFA2::plot_weights(FlomicsMultiAssay@metadata$MOFA_results,
                                                         view = j,
                                                         factor = i,
                                                         nfeatures = 10,
                                                         scale = TRUE) + ggplot2::ggtitle(paste0(j, " - Factor ", i))
  }
}

ggpubr::ggarrange(plotlist = ggplot_list,
                  ncol = length(MOFA2::views_names(FlomicsMultiAssay@metadata$MOFA_results)),
                  nrow = length(FactNum[FactNum]))
```



```{r, fig.width = 10, fig.height = 7}
MOFA2::plot_weights_heatmap(FlomicsMultiAssay@metadata$MOFA_results)
```

