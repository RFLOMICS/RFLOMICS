### {.tabset}

<details>
<summary>**`r paste0("[",tag,"] ",contrast)`**</summary>

```{r }

# Create a directory to store the results by contrast
contrastDir <- 
  paste0(diffDir[[data]],"/",  tag, "_", 
         RFLOMICS:::contrastName2contrastDir(contrast),"/")
                      
dir.create(path=contrastDir, recursive = TRUE, showWarnings = FALSE)

opts_chunk$set(
  fig.path=contrastDir
)

dataset.SE <- getRflomicsSE(rflomics.MAE, data)
evalPCA <- dim(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]])[1] > 1
evalExport <-  dim(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]])[1] > 0
```


```{r , out.width = "50%"}
diff.plots <- plotDiffAnalysis(dataset.SE, contrastName=contrast)
```

#### Pvalues distribution

```{r pvDistrib-plot, out.width = "60%", fig.cap=paste0("<p style=\"color:grey\">","*fig: Distribution of non-adjusted p-values. The most desirable shape is a peak of p-values at 0 following by a uniform distribution.*", "</p>")}
diff.plots$Pvalue.hist
```

#### MA plot

```{r MA-plot, out.width = "60%", fig.cap=paste0("<p style=\"color:grey\">","*fig: Expect a majority of ", variableName," around 0. The red points are the ", variableName," significantly over-expressed in the left factor's modality in the contrast expression whereas blue points are ",variableName," significantly under-expressed in the rigth factor's modality in the contrast expression. Only the top 20 ", variableName," DE are labeled.*", "</p>")}
diff.plots$MA.plot
```

#### VolcanoPlot

```{r Volcano-plot, out.width = "60%", fig.cap=paste0("<p style=\"color:grey\">","*fig: Red points are ", variableName," of interest displaying both large magnitude log-fold-changes (x axis) and high statistical significance (y axis). Only the top 20 ",variableName," DE are labeled.*", "</p>")}
diff.plots$Volcano.plot
```

#### Heatmap:

```{r heatmap-plot, out.width = "60%", fig.cap=paste0("<p style=\"color:grey\">","*fig: Heatmap was performed on DE ", variableName," expression data table which has been transformed by: ", getTransSettings(dataset.SE)$method," method and normalized by: ", getNormSettings(dataset.SE)$method," method. Clustering was independently performed on samples (row) and centered ", variableName," (column) using euclidian distance and complete aggregation method*", "</p>")}
plotHeatmapDesign(object = dataset.SE, contrastName = contrast)
```

#### PCA on DE 

```{r PCAonDE, out.width = "50%",fig.show = "hold", eval = evalPCA, fig.cap=paste0("<p style=\"color:grey\">","fig: ???.", "</p>")}

resTable <- metadata(dataset.SE)$DiffExpAnal[["TopDEF"]][[contrast]]
newDataset.SE <- dataset.SE[rownames(dataset.SE) %in% row.names(resTable)]
newDataset.SE <- runOmicsPCA(newDataset.SE)  

plotOmicsPCA(newDataset.SE,
                  raw = "norm",
                  axes=c(1, 2), groupColor="groups")
plotOmicsPCA(newDataset.SE,
                  raw = "norm",
                  axes=c(1, 3), groupColor="groups")
```


#### Table of DE

* results of the differential expression/abundance statistical analysis:
  + `r variableName` ID
  + logFC: log2 fold change
  + Abundance: mean expression/abundance for the factor's modality
  + t: t-statistic (limma-lmFit, prot/metabo)
  + pvalue: p-values
  + Adj.value: adjusted p-value (BH)
  + LR: likelihood ratio test (edgeR-glmLRT, RNAseq)
  + B: log-odds that the prot/metabo is differentially expressed (limma-topTable)
  + Regulation: Up (green) or Down (red) regulated

```{r table , eval = evalExport, fig.cap=paste0("<p style=\"color:grey\">","tab: ???", "</p>")}
df <- signif(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]],3)

datatable(df, rownames = TRUE , class = 'cell-border stripe',
              options = list(pageLength = 6, scrollX = F, lengthChange = F)) |> 
  formatStyle(
      'logFC',
      color = styleInterval(c(0), c('red', 'green'))
    )

```


```{r , eval = evalExport}
write.table(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]],
             file=paste0(contrastDir,"Table_of_DE_", variableName,"_pvalmax_",
                         dataset.SE@metadata[["DiffExpAnal"]][["p.adj.cutoff"]],"_FCmin_",
                         dataset.SE@metadata[["DiffExpAnal"]][["abs.logFC.cutoff"]],".txt"),
             sep="\t",quote=FALSE,col.names=TRUE,row.names=TRUE)
 
 write.table(dataset.SE@metadata[["DiffExpAnal"]][["DEF"]][[contrast]],
             file=paste0(contrastDir,"Table_of_non_filtering_", variableName,".txt"),
             sep="\t",quote=FALSE,col.names=TRUE,row.names=TRUE)
```

### {-}