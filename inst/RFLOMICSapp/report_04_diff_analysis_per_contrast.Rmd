
<details>
<summary>`r contrast`</summary>


```{r , echo=FALSE , message=FALSE, warning=FALSE}

# Create a directory to store the results by contrast

contrastDir <- paste0(anaDiffDir,"/", RFLOMICS:::.convertContrastToTag(dataset.SE,contrast), "_" , RFLOMICS:::contrastName2contrastDir(contrast),"/")
                      
dir.create(path=contrastDir)

knitr::opts_chunk$set(
  fig.path=contrastDir
)

evalPCA <- dim(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]])[1] > 1
evalExport <-  dim(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]])[1] > 0
```


```{r , echo=FALSE,out.width = "50%"}
diff.plots <- plotDiffAnalysis(dataset.SE, contrastName=contrast)
```



1- Pvalues distribution

*Distribution of non-adjusted p-values. The most desirable shape is a peak of p-values at 0 following by a uniform distribution*

```{r pvDistrib-plot, echo=FALSE,out.width = "40%", warning=FALSE}
diff.plots$Pvalue.hist
```

2- MA plot

*Expect a majority of* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *around 0. The red points are the* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *significantly over-expressed in the left factor's modality in the contrast expression whereas blue points are* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *significantly under-expressed in the rigth factor's modality in the contrast expression. Only the top 20* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *DE are labeled.*

```{r MA-plot, echo=FALSE,out.width = "40%", warning=FALSE}
diff.plots$MA.plot
```

3- VolcanoPlot

*Red points are* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *of interest displaying both large magnitude log-fold-changes (x axis) and high statistical significance (y axis). Only the top 20* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *DE are labeled.*

```{r Volcano-plot, echo=FALSE,out.width = "40%", warning=FALSE}
diff.plots$Volcano.plot
```


3- Heatmap:

*Heatmap was performed on DE* `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` *expression data table which has been transformed by:* `r getTransSettings(dataset.SE)$method` *method and normalized by:* 
`r getNormSettings(dataset.SE)$method` *method.*
*Clustering was independently performed on samples (row) and centered `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` (column) using euclidian distance and complete aggregation method*

```{r heatmap-plot, echo=FALSE,out.width = "40%", warning=FALSE}
plotHeatmapDesign(object = dataset.SE, contrastName = contrast)
```


4- PCA on DE 

```{r PCAonDE, echo=FALSE,out.width = "40%",fig.show = "hold", eval = evalPCA}

resTable <- metadata(dataset.SE)$DiffExpAnal[["TopDEF"]][[contrast]]
newDataset.SE <- dataset.SE[rownames(dataset.SE) %in% row.names(resTable)]
newDataset.SE <- RFLOMICS::runOmicsPCA(newDataset.SE)  

RFLOMICS::plotOmicsPCA(newDataset.SE,
                  raw = "norm",
                  axes=c(1, 2), groupColor="groups")
RFLOMICS::plotOmicsPCA(newDataset.SE,
                  raw = "norm",
                  axes=c(1, 3), groupColor="groups")
```


5- Table of DE

* results of the differential expression/abundance statistical analysis:
  + `r RFLOMICS:::.omicsDic(dataset.SE)[["variableName"]]` ID
  + logFC: log2 fold change
  + Abundance: mean expression/abundance for the factor's modality
  + t: t-statistic (limma-lmFit, prot/metabo)
  + pvalue: p-values
  + Adj.value: adjusted p-value (BH)
  + LR: likelihood ratio test (edgeR-glmLRT, RNAseq)
  + B: log-odds that the prot/metabo is differentially expressed (limma-topTable)
  + Regulation: Up (green) or Down (red) regulated

```{r table, echo = FALSE, out.width = "70%" , eval = evalExport}

reactable::reactable(signif(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]],3),
          showSortable = TRUE,
          bordered = TRUE,
          defaultPageSize = 6, searchable = TRUE, paginationType = "simple",
          columns = list(
            logFC = reactable::colDef(
                style = function(value) {
                    color <- if (value >= 0) {
                      "#C7DCA7"
                    } else if (value < 0) {
                      "#FFC5C5"
                    }
                    list(fontWeight = 600, color = color)
                }
              )
            )
          )

 write.table(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]],
             file=paste0(contrastDir,"Table_of_DE_", RFLOMICS:::omicsDic(dataset.SE)[["variableName"]],"_pvalmax_",
                         dataset.SE@metadata[["DiffExpAnal"]][["p.adj.cutoff"]],"_FCmin_",
                         dataset.SE@metadata[["DiffExpAnal"]][["abs.logFC.cutoff"]],".txt"),
             sep="\t",quote=FALSE,col.names=TRUE,row.names=TRUE)
 
 write.table(dataset.SE@metadata[["DiffExpAnal"]][["DEF"]][[contrast]],
             file=paste0(contrastDir,"Table_of_non_filtering_", RFLOMICS:::omicsDic(dataset.SE)[["variableName"]],".txt"),
             sep="\t",quote=FALSE,col.names=TRUE,row.names=TRUE)
```


</details>


