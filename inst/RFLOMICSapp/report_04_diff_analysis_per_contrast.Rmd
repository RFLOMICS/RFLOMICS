
<details>
<summary>`r contrast`</summary>


```{r , echo=FALSE , message=FALSE, warning=FALSE}

# Create a directory to store the results by contrast

contrastDir <- paste0(anaDiffDir,"/", RFLOMICS:::convertContrastToTag(dataset.SE,contrast), "_" , contrastName2contrastDir(contrast),"/")
                      
dir.create(path=contrastDir)

knitr::opts_chunk$set(
  fig.path=contrastDir
)

evalPCA <- dim(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]])[1] > 1
evalExport <-  dim(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]])[1] > 0
```


```{r , echo=FALSE,out.width = "50%"}
diff.plots <- plotDiffAnalysis(dataset.SE, contrastName=contrast)
```


1- Pvalues distribution

```{r pvDistrib-plot, echo=FALSE,out.width = "40%", warning=FALSE}
diff.plots$Pvalue.hist
```

2- MA plot

```{r MA-plot, echo=FALSE,out.width = "40%", warning=FALSE}
diff.plots$MA.plot
```

3- VolcanoPlot

```{r Volcano-plot, echo=FALSE,out.width = "40%", warning=FALSE}
diff.plots$Volcano.plot
```


3- Heatmap of the euclidean distances with a link of Ward 

```{r heatmap-plot, echo=FALSE,out.width = "40%", warning=FALSE}
plotHeatmapDesign(object = dataset.SE, contrastName = contrast)
```


4- PCA on DE 

```{r PCAonDE, echo=FALSE,out.width = "40%",fig.show = "hold", eval = evalPCA}

resTable <- dataset.SE@metadata$DiffExpAnal[["TopDEF"]][[contrast]]
newDataset.SE <- dataset.SE[rownames(dataset.SE) %in% row.names(resTable)]
newDataset.SE <- RFLOMICS::RunPCA(newDataset.SE)  

RFLOMICS::plotPCA(newDataset.SE,
                  PCA = "norm",
                  PCs=c(1, 2), condition="groups")
RFLOMICS::plotPCA(newDataset.SE,
                  PCA = "norm",
                  PCs=c(1, 3), condition="groups")
```


5- Table

```{r table, echo = FALSE, out.width = "70%" , eval = evalExport}

reactable::reactable(signif(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]],3),
          showSortable = TRUE,
          bordered = TRUE,
          defaultPageSize = 6, searchable = TRUE, paginationType = "simple",
          columns = list(
            logFC = reactable::colDef(
                style = function(value) {
                    color <- if (value >= 0) {
                      "#008000"
                    } else if (value < 0) {
                      "#e00000"
                    }
                    list(fontWeight = 600, color = color)
                }
              )
            )
          )

 write.table(dataset.SE@metadata[["DiffExpAnal"]][["TopDEF"]][[contrast]],
             file=paste0(contrastDir,"Table_of_DE_", RFLOMICS:::omicsDic(dataset.SE)[["variableName"]],"_pvalmax_",
                         dataset.SE@metadata[["DiffExpAnal"]][["p.adj.cutoff"]],"_FCmin_",
                         dataset.SE@metadata[["DiffExpAnal"]][["abs.logFC.cutoff"]],".txt"),
             sep="\t",quote=FALSE,col.names=TRUE,row.names=TRUE)
 
 write.table(dataset.SE@metadata[["DiffExpAnal"]][["DEF"]][[contrast]],
             file=paste0(contrastDir,"Table_of_non_filtering_", RFLOMICS:::omicsDic(dataset.SE)[["variableName"]],".txt"),
             sep="\t",quote=FALSE,col.names=TRUE,row.names=TRUE)
```


</details>


